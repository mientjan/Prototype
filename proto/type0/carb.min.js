/**
 *	Carb
 *	
 *	@author Mient-jan Stelling
 ***/
var carb={};carb.load=function(a,b){this.mix=a;this.fn=b;this.loaded=0;if(typeof a.length!="number"){this.mix=[this.mix]}this.mix.each(function(a,b){this.mix[b]=new Image;this.mix[b].onload=this._onload.bind(this);this.mix[b].src=a},this)};carb.load.prototype._onload=function(){this.loaded++;if(this.mix.length==this.loaded){this.fn.call(null,this.mix)}};carb.canvas=function(a,b){this.el=document.createElement("canvas");this.el.width=a;this.el.height=b;this.width=a;this.height=b};carb.canvas.prototype.hide=function(){this.el.style.display="none";return this};carb.canvas.prototype.show=function(){this.el.style.display="block";return this};carb.canvas.prototype.inject=function(a){a.appendChild(this.el);return this};carb.canvas.prototype.get=function(a){switch(a){case"ctx":{if(!this.ctx){this.ctx=this.el.getContext("2d")}return this.ctx;break};case"width":case"height":case"el":{return this[a];break}}return null};carb.canvas.prototype.set=function(a,b){if(a=="width"){this.el.width=b;this.width=b}else if(a=="height"){this.el.height=b;this.height=b}return this};carb.shape={};carb.shape.triangle=function(a,b,c,d){a.beginPath();a.moveTo(b,c);a.lineTo(b,c-d);a.lineTo(b-d,c);a.closePath();a.fill()};carb.shape.piramid=function(a,b,c,d,e){a.save();a.translate(b,c);if(e)a.rotate(e);a.beginPath();a.moveTo(-d/2,-d/2);a.lineTo(-d/2,d/2);a.lineTo(0,0);a.closePath();a.fill();a.restore()};clamp=function(a,b,c){if(a<b)return b;if(a>c)return c-1;return a}

/**
 *	All credits go to <http://29a.ch/> Jonas Wagner. For the normal mapping
 **/
if(!carb.map)carb.map={};carb.map.normal=function(a){if(a){this.setTarget(a)}};carb.map.normal.prototype.shiny=1.2;carb.map.normal.prototype.specularity=0;carb.map.normal.prototype._normals=[];carb.map.normal.prototype._texture=[];carb.map.normal.prototype.setMap=function(a){this.map=a;var b=this.map.get("ctx").getImageData(0,0,this.map.get("width"),this.map.get("height")).data;this._texture=this.source.get("ctx").getImageData(0,0,this.source.get("width"),this.source.get("height")).data;for(var c=0,d=this.map.height*this.map.width*4;c<d;c+=4){var e=b[c];var f=255-b[c+1];var g=b[c+2];var h=1/Math.sqrt(e*e+f*f+g*g);e*=h;f*=h;g*=h;this._normals.push(e);this._normals.push(f);this._normals.push(g)}};carb.map.normal.prototype.setTarget=function(a){this.target=a};carb.map.normal.prototype.setSource=function(a){console.log(a);this.source=a};carb.map.normal.prototype.getImageData=function(a,b,c,d,e){b=b||0;c=c||0;switch(a){case"source":case"map":case"target":{d=d||this[a].get("width");e=e||this[a].get("height");this[a].getImageData(b,c,d,e);break}}};carb.map.normal.prototype.draw=function(a,b,c){var d=this.target.ctx.getImageData(0,0,this.target.width,this.target.height),e=d.data;i=0,ni=0,dx=0,dy=0,dz=0,x=0,y=0,width=this.target.width,height=this.target.height;for(var f=0,g=width*height;f<g;f++){x=f%width;y=Math.floor(f/width);nx=this._normals[ni];ny=this._normals[ni+1];nz=this._normals[ni+2];if(this.shiny>0||(ni&1)==0){dx=a-x;dy=b-y;dz=c;magInv=1/Math.sqrt(dx*dx+dy*dy+dz*dz);dx*=magInv;dy*=magInv;dz*=magInv}var h=dx*nx+dy*ny+dz*nz,j=Math.pow(h,20)*this.specularity+Math.pow(h,400)*this.shiny,k=j+.5;for(var l=0;l<3;l++){e[i+l]=Math.round(clamp(this._texture[i+l]*k,0,255))}i+=4;ni+=3}this.target.ctx.putImageData(d,0,0)}