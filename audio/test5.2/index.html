<html prefix="og: http://ogp.me/ns#">
<head>
<title>Audio Test 5.2</title>
<meta property="og:image" content="http://mientjan.github.com/Prototype/audio/test5.2.png" />

<script src="../build/mootools.js"></script>
<script src="../build/Three.js"></script>

<script src="../test5/AC.js"></script>
<script src="../test5/AC/BiquadFilterNode.js"></script>
<script src="../test5/AC/Speaker.js"></script>
<script src="../test5/AC/Sound.js"></script>


<script>
	requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame ||  
		window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
</script>


</head>
<body>
	<fieldset>
		<legend><h1>Audio Test 5.2</h1></legend>
		<p>
			WEBGL with THREE, and the new audio processor, now with a mediamonk and particles. <strong>Works only in the newest Chrome</strong><br />
		</p>
		
		<div id="container" style="background-color: #000;"></div>
		
		<button id="playsound" onclick="analyser.connect(processor);
		processor.connect(speakers.o); sound.play();">Play doctor_p-big_boss.mp3</button>
		
		<button onclick="$('container').setStyle('background-color','#000');"> Background Black</button>
		<button onclick="$('container').setStyle('background-color','#FFF');"> Background White</button>
	</fieldset>
	
	

	<script>
		
		// scene size
		var width = 800,
			height = 500,
			
			// camera attr
			view_angle = 45,
			aspect = width / height,
			near = 0.1,
			far = 10000;
		
		var container = $('container');
		var renderer = new THREE.WebGLRenderer();
		var camera = new THREE.PerspectiveCamera(
			view_angle, aspect, near, far );
		
		var scene = new THREE.Scene();
		camera.position.z = 300;
		renderer.setSize(width, height);
		container.appendChild(renderer.domElement);
		
		// de stoff
		var sphereMaterial = new THREE.MeshPhongMaterial({ color: 0xFFFFFF });
		
		var radius = 30,
			segments = 32,
			rings = 32,
			sphere;
		
		var geo1; 
		
		var jsonLoader = new THREE.JSONLoader();
        jsonLoader.load( "../newmonk_v09.js", function( geometry ) { 
			geo1 = Object.clone(geometry);
			sphere = new THREE.Mesh( geometry, sphereMaterial );
			scene.add(sphere);
			
		} );

		// setting up some awesome particles
		var particleCount = 1024,
			particles = new THREE.Geometry();
		
		var pMaterial = new THREE.ParticleBasicMaterial({
			color: 0xFFFFFF,
			size: 100,
			map: THREE.ImageUtils.loadTexture(
				"particle.png"
			),
			blending: THREE.AdditiveBlending,
			transparent: true
		});
		var p2 = [];

		for(var p = 0; p < particleCount; p++) {

		// create a particle with random
		// position values, -250 -> 250
			var pX = Math.random() * 500 - 250,
				pY = Math.random() * 500 - 250,
				pZ = Math.random() * 500 - 250;
			
			p2[p] = new THREE.Vector3(pX, pY, pZ);
			var particle = new THREE.Vertex(
					new THREE.Vector3(pX, pY, pZ)
				);

			// add it to the geometry
			particles.vertices.push(particle);
		}
		
		// create the particle system
		var particleSystem = new THREE.ParticleSystem( particles, pMaterial);
		
		scene.add(particleSystem);
		
		// particle matreaal

		
		particleSystem.sortParticles = true;
		
		
		// licht
		var pointLight = new THREE.PointLight(0xFFB00F);
		pointLight.position.x = 10;
		pointLight.position.y = 50;
		pointLight.position.z = 130;
		
		scene.add(pointLight);
		
		var rnd = 0.0;
		function render(time){
			
			renderer.render( scene, camera);
			
			console.log(sphere);
			sphere.geometry.dynamic = true;
			sphere.geometry.__dirtyVertices = true;
			
			
			// requestAnimationFrame(render);
		}
		
		
		
	</script>
	<script>
		var freqByteData,
		timeByteData,
		timeByteData,
		analyser,
		centerX,
		centerY,
		averageLevel,
		level,
		sum;



		var a = new AC();

		$('playsound').innerHTML = 'loading';
		var sound = new AC.Sound('../doctor_p-big_boss.mp3', function(){ 
			$('playsound').innerHTML = 'play';
		});
		var speakers = new AC.Speaker();
		sound.connect(speakers);

		analyser = a.ctx.createAnalyser();
		var processor = a.ctx.createJavaScriptNode(1024, 1, 1);
		
		var oneTime = true;
		processor.onaudioprocess = function(e){

			particleSystem.geometry.__dirtyVertices = true;
			
			//analyser.smoothingTimeConstant = 0.1;
			analyser.getByteFrequencyData(freqByteData);
			analyser.getByteTimeDomainData(timeByteData);

			sum = 0;
			for(var i = 0, l = freqByteData.length; i < l; ++i) {
				sum += freqByteData[i];
			}

			averageLevel = sum / l;
			// console.log(sum, averageLevel);
			level = averageLevel;

			centerX = (600 - level)/2;
			centerY = (400 - level)/2;

			// ctx.fillRect (599, centerY, 1, level);
			
			// console.log(averageLevel);
			sphere.scale.x = level;
			sphere.scale.y = level;
			sphere.scale.z = level;

			sphere.rotation.y += .1;
			particleSystem.rotation.y += 0.01;
			// console.log( (timeByteData[0]/100) );
			var t1 = 0,
				t2 = 0,
				t3 = 0,
				t = 0;
			for( var i = 0, l = sphere.geometry.vertices.length; i < l; ++i){
				t1 = (timeByteData[i%timeByteData.length]/100);
				
				t2 = freqByteData[i%timeByteData.length]/100;
				//t3 = ( timeByteData[i] / freqByteData[i] );
				
				t = (t2 / t1);
				
				if(particles.vertices[i]){
					particles.vertices[i].position.y = p2[i].y * t1;
					particles.vertices[i].position.x = p2[i].x * t1;
					particles.vertices[i].position.z = p2[i].z * t1;
				}

				
				if(oneTime){
					oneTime = false; 
					console.log( particles.vertices[i] );
				} 
				
				//sphere.geometry.vertices[i].position.x = geo1.vertices[i].position.x * t2;
				//sphere.geometry.vertices[i].position.y = geo1.vertices[i].position.y * t2;
				//sphere.geometry.vertices[i].position.z = geo1.vertices[i].position.z * t2;
			}
			
			// console.log(t2, freqByteData[0], freqByteData.length, l);
			
			if(level>0 && oneTime){
				// console.log(freqByteData[0] / timeByteData[0]);
				oneTime = false;
			}
			
			renderer.render( scene, camera);
			// requestAnimationFrame(render);

		}

		sound.connect({'o':analyser});
		

		freqByteData = new Uint8Array(analyser.frequencyBinCount);
		timeByteData = new Uint8Array(analyser.frequencyBinCount);
		
		console.log(sound);
	</script>
	
	
	
</body>
</html>